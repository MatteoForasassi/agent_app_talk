<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Conversazione con Avatar</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      color: #333;
    }

    /* ========== LANDING PAGE ========== */
    #landingPage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      gap: 40px;
    }

    #landingPage h1 {
      font-size: 48px;
      color: white;
      text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    #landingPage p {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      max-width: 600px;
    }

    .username-input {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }

    .username-input input {
      padding: 16px 24px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      outline: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .username-input input:focus {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    #connectBtn {
      padding: 20px 50px;
      font-size: 24px;
      font-weight: 700;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #connectBtn:hover:not(:disabled) {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      background: #f0f0f0;
    }

    #connectBtn:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
      transform: none;
    }

    /* ========== MAIN APP (HIDDEN INITIALLY) ========== */
    .container {
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 20px;
      flex: 1;
    }

    .container.active {
      display: flex;
    }

    .header {
      text-align: center;
      color: white;
      padding: 20px 0;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .user-info {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 8px;
    }

    /* ========== AVATAR STATUS CARD ========== */
    .avatar-status-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .avatar-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .avatar-icon {
      font-size: 48px;
    }

    .avatar-state {
      font-size: 18px;
      font-weight: 600;
    }

    .avatar-state.idle {
      color: #10b981;
    }

    .avatar-state.busy {
      color: #ef4444;
    }

    .queue-info {
      padding: 12px;
      background: #fef3c7;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
      color: #92400e;
    }

    .active-user-info {
      padding: 12px;
      background: #dbeafe;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
      color: #1e40af;
    }

    /* ========== CONTROLS ========== */
    .controls {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .control-section {
      margin-bottom: 20px;
    }

    .control-section:last-child {
      margin-bottom: 0;
    }

    .control-section h3 {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 140px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #10b981;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #d97706;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #4b5563;
    }

    .btn-recording {
      background: #dc2626;
      color: white;
      animation: pulse-recording 1.5s infinite;
    }

    @keyframes pulse-recording {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
      }
      50% {
        opacity: 0.9;
        box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
      }
    }

    /* Hold to record button specific styles */
    #holdRecBtn {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: none;
    }

    .status {
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      font-size: 14px;
      margin-top: 16px;
    }

    .status.idle {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status.connecting {
      background: #fef3c7;
      color: #92400e;
    }

    .status.active {
      background: #dcfce7;
      color: #166534;
    }

    .status.waiting {
      background: #fef3c7;
      color: #92400e;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ========== TRANSCRIPT ========== */
    .transcript-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }

    .transcript-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f3f4f6;
    }

    .transcript-header h2 {
      font-size: 18px;
      color: #1f2937;
    }

    #clearBtn {
      padding: 8px 16px;
      font-size: 14px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    #clearBtn:hover {
      background: #e5e7eb;
    }

    .transcript-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 16px;
      line-height: 1.6;
      color: #374151;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .transcript-content:empty::before {
      content: "La trascrizione apparir√† qui...";
      color: #9ca3af;
      font-style: italic;
    }

    .interim {
      color: #9ca3af;
      font-style: italic;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }

      #landingPage h1 {
        font-size: 36px;
      }

      #landingPage p {
        font-size: 16px;
      }

      #connectBtn {
        padding: 16px 32px;
        font-size: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .controls, .transcript-container, .avatar-status-card {
        padding: 16px;
      }

      button {
        min-width: 120px;
        padding: 14px 20px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- ========== LANDING PAGE ========== -->
  <div id="landingPage">
    <div>
      <h1>ü§ñ Avatar Virtuale</h1>
      <p>Inserisci il tuo nome e connettiti per parlare con l'avatar</p>
    </div>
    <div class="username-input">
      <input 
        type="text" 
        id="usernameInput" 
        placeholder="Il tuo nome" 
        maxlength="30"
      >
      <button id="connectBtn" disabled>
        Connetti
      </button>
    </div>
  </div>

  <!-- ========== MAIN APP (HIDDEN) ========== -->
  <div class="container" id="mainApp">
    <div class="header">
      <h1>ü§ñ Conversazione con Avatar</h1>
      <div class="user-info">
        <span id="userDisplay"></span> ‚Ä¢ <span id="userIdDisplay"></span>
      </div>
    </div>

    <!-- Avatar Status Card -->
    <div class="avatar-status-card">
      <div class="avatar-indicator">
        <span class="avatar-icon">ü§ñ</span>
        <span id="avatarState" class="avatar-state idle">Avatar Libero</span>
      </div>
      <div id="queueInfo" class="queue-info" style="display: none;">
        In attesa... Posizione in coda: <strong id="queuePosition">-</strong>
      </div>
      <div id="activeUserInfo" class="active-user-info" style="display: none;">
        Conversazione attiva: <strong id="activeUsername">-</strong>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <!-- Conversation Control -->
      <div class="control-section">
        <h3>Controllo Conversazione</h3>
        <div class="button-group">
          <button id="startConvBtn" class="btn-primary" disabled>
            <span>üí¨</span>
            <span>Inizia Conversazione</span>
          </button>
          <button id="endConvBtn" class="btn-danger" disabled>
            <span>üö™</span>
            <span>Termina Conversazione</span>
          </button>
        </div>
      </div>

      <!-- Recording Control - HOLD TO RECORD -->
      <div class="control-section">
        <h3>Registrazione</h3>
        <div class="button-group">
          <button id="holdRecBtn" class="btn-primary" disabled>
            <span>üé§</span>
            <span>Tieni Premuto per Registrare</span>
          </button>
        </div>
      </div>

      <!-- Queue Control -->
      <div class="control-section" id="queueControlSection" style="display: none;">
        <h3>Azioni</h3>
        <div class="button-group">
          <button id="leaveQueueBtn" class="btn-secondary">
            <span>‚ùå</span>
            <span>Abbandona Coda</span>
          </button>
        </div>
      </div>

      <div id="status" class="status idle">Disconnesso</div>
    </div>

    <!-- Transcript -->
    <div class="transcript-container">
      <div class="transcript-header">
        <h2>Trascrizione</h2>
        <button id="clearBtn">Cancella</button>
      </div>
      <div id="transcript" class="transcript-content"></div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const DEEPGRAM_API_KEY = '87ce09f5219486e115182b4252e98370723dda2b';
    const RELAY_SERVER_URL = 'wss://agent-app-talk.onrender.com';

    // ========== STATE ==========
    let relaySocket = null;
    let audioStream = null;
    let mediaRecorder = null;
    let audioChunks = [];

    let userState = 'disconnected'; // 'disconnected' | 'waiting' | 'active'
    let conversationActive = false;
    let isRecording = false;
    let userId = null;
    let username = '';
    let queuePosition = null;

    let finalTranscript = '';

    // ========== DOM ELEMENTS ==========
    const landingPage = document.getElementById('landingPage');
    const mainApp = document.getElementById('mainApp');
    const usernameInput = document.getElementById('usernameInput');
    const connectBtn = document.getElementById('connectBtn');
    
    const userDisplay = document.getElementById('userDisplay');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const avatarState = document.getElementById('avatarState');
    const queueInfo = document.getElementById('queueInfo');
    const queuePositionSpan = document.getElementById('queuePosition');
    const activeUserInfo = document.getElementById('activeUserInfo');
    const activeUsernameSpan = document.getElementById('activeUsername');
    
    const startConvBtn = document.getElementById('startConvBtn');
    const endConvBtn = document.getElementById('endConvBtn');
    const holdRecBtn = document.getElementById('holdRecBtn');
    const leaveQueueBtn = document.getElementById('leaveQueueBtn');
    const queueControlSection = document.getElementById('queueControlSection');
    
    const statusDiv = document.getElementById('status');
    const transcriptDiv = document.getElementById('transcript');
    const clearBtn = document.getElementById('clearBtn');

    // ========== USERNAME INPUT ==========
    usernameInput.addEventListener('input', () => {
      connectBtn.disabled = usernameInput.value.trim().length === 0;
    });

    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !connectBtn.disabled) {
        connectBtn.click();
      }
    });

    // ========== CONNECT BUTTON ==========
    connectBtn.addEventListener('click', () => {
      username = usernameInput.value.trim();
      if (!username) return;
      
      landingPage.style.display = 'none';
      mainApp.classList.add('active');
      
      connectToRelay();
    });

    // ========== RELAY CONNECTION ==========
    function connectToRelay() {
      try {
        updateStatus('Connessione al server...', 'connecting');
        
        relaySocket = new WebSocket(RELAY_SERVER_URL);
        
        relaySocket.onopen = () => {
          console.log('Connected to relay server');
          
          // Identify as web client with username
          relaySocket.send(JSON.stringify({
            type: 'identify',
            client: 'web',
            username: username
          }));
        };

        relaySocket.onmessage = (event) => {
          handleServerMessage(event.data);
        };

        relaySocket.onclose = () => {
          console.log('Disconnected from relay server');
          handleDisconnection();
        };

        relaySocket.onerror = (error) => {
          console.error('Relay server error:', error);
          updateStatus('Errore di connessione', 'error');
        };
        
      } catch (error) {
        console.error('Failed to connect to relay:', error);
        updateStatus('Connessione fallita', 'error');
      }
    }

    // ========== SERVER MESSAGE HANDLER ==========
    function handleServerMessage(data) {
      try {
        const message = JSON.parse(data);
        console.log('Server message:', message);
        
        switch (message.type) {
          case 'registered':
            handleRegistered(message);
            break;
            
          case 'promoted_to_active':
            handlePromotedToActive();
            break;
            
          case 'queue_update':
            handleQueueUpdate(message);
            break;
            
          case 'conversation_started':
            handleConversationStarted();
            break;
            
          case 'kicked_out':
            handleKickedOut(message);
            break;
            
          case 'avatar_busy':
            handleAvatarBusy(message);
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
        
      } catch (error) {
        console.error('Error processing server message:', error);
      }
    }

    // ========== MESSAGE HANDLERS ==========
    function handleRegistered(message) {
      userId = message.userId;
      userState = message.state;
      
      userDisplay.textContent = username;
      userIdDisplay.textContent = `ID: ${userId}`;
      
      if (userState === 'active') {
        updateStatus('Sei attivo! Puoi iniziare la conversazione', 'active');
        startConvBtn.disabled = false;
        avatarState.textContent = 'Sei Attivo';
        avatarState.className = 'avatar-state busy';
        queueInfo.style.display = 'none';
        activeUserInfo.style.display = 'none';
        queueControlSection.style.display = 'none';
        
      } else if (userState === 'waiting') {
        queuePosition = message.queuePosition;
        updateStatus(`In coda - Posizione: ${queuePosition}`, 'waiting');
        queuePositionSpan.textContent = queuePosition;
        queueInfo.style.display = 'block';
        activeUserInfo.style.display = 'none';
        avatarState.textContent = 'Avatar Occupato';
        avatarState.className = 'avatar-state busy';
        queueControlSection.style.display = 'block';
      }
    }

    function handlePromotedToActive() {
      userState = 'active';
      updateStatus('‚úÖ Sei stato promosso! Puoi iniziare la conversazione', 'active');
      startConvBtn.disabled = false;
      avatarState.textContent = 'Sei Attivo';
      avatarState.className = 'avatar-state busy';
      queueInfo.style.display = 'none';
      activeUserInfo.style.display = 'none';
      queueControlSection.style.display = 'none';
      
      // Alert user
      if (document.hidden) {
        new Notification('Il tuo turno!', {
          body: 'Puoi iniziare la conversazione con l\'avatar',
          icon: 'ü§ñ'
        });
      }
    }

    function handleQueueUpdate(message) {
      if (userState === 'waiting') {
        queuePosition = message.position;
        queuePositionSpan.textContent = queuePosition;
        updateStatus(`In coda - Posizione: ${queuePosition} (${message.totalWaiting} in attesa)`, 'waiting');
      }
    }

    function handleConversationStarted() {
      conversationActive = true;
      startConvBtn.disabled = true;
      endConvBtn.disabled = false;
      holdRecBtn.disabled = false;
      updateStatus('Conversazione attiva - Tieni premuto per registrare', 'active');
    }

    function handleKickedOut(message) {
      stopRecording();
      updateStatus(message.reason || 'Sei stato disconnesso', 'error');
      
      setTimeout(() => {
        if (relaySocket) {
          relaySocket.close();
        }
        returnToLanding();
      }, 3000);
    }

    function handleAvatarBusy(message) {
      activeUsernameSpan.textContent = message.activeUser || 'Sconosciuto';
      activeUserInfo.style.display = 'block';
    }

    // ========== CONVERSATION CONTROL ==========
    startConvBtn.addEventListener('click', () => {
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.send(JSON.stringify({
          type: 'start_conversation'
        }));
        updateStatus('Avvio conversazione...', 'connecting');
      }
    });

    endConvBtn.addEventListener('click', () => {
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.send(JSON.stringify({
          type: 'end_conversation'
        }));
        
        stopRecording();
        conversationActive = false;
        startConvBtn.disabled = false;
        endConvBtn.disabled = true;
        holdRecBtn.disabled = true;
        
        updateStatus('Conversazione terminata', 'idle');
        
        // Return to landing after delay
        setTimeout(() => {
          if (relaySocket) {
            relaySocket.close();
          }
          returnToLanding();
        }, 2000);
      }
    });

    // ========== HOLD TO RECORD ==========
    // Mouse events
    holdRecBtn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      if (!holdRecBtn.disabled) {
        startRecording();
      }
    });

    holdRecBtn.addEventListener('mouseup', (e) => {
      e.preventDefault();
      if (isRecording) {
        stopRecording();
      }
    });

    holdRecBtn.addEventListener('mouseleave', (e) => {
      if (isRecording) {
        stopRecording();
      }
    });

    // Touch events for mobile
    holdRecBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (!holdRecBtn.disabled) {
        startRecording();
      }
    });

    holdRecBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      if (isRecording) {
        stopRecording();
      }
    });

    holdRecBtn.addEventListener('touchcancel', (e) => {
      if (isRecording) {
        stopRecording();
      }
    });

    // ========== RECORDING ==========
    async function startRecording() {
      try {
        updateStatus('üî¥ Registrazione in corso...', 'active');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Il tuo browser non supporta l\'accesso al microfono');
        }

        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          } 
        });

        audioChunks = [];
        mediaRecorder = new MediaRecorder(audioStream);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await sendToDeepgram(audioBlob);
          
          if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
          }
        };

        mediaRecorder.start();
        isRecording = true;
        holdRecBtn.classList.add('btn-recording');
        
      } catch (error) {
        handleError(error);
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        holdRecBtn.classList.remove('btn-recording');
        updateStatus('Elaborazione audio...', 'connecting');
      }
    }

    // ========== SEND TO DEEPGRAM ==========
    async function sendToDeepgram(audioBlob) {
      try {
        const response = await fetch('https://api.deepgram.com/v1/listen?language=it&punctuate=true&model=nova-2', {
          method: 'POST',
          headers: {
            'Authorization': `Token ${DEEPGRAM_API_KEY}`,
            'Content-Type': 'audio/webm'
          },
          body: audioBlob
        });

        if (!response.ok) {
          throw new Error(`Deepgram error: ${response.status}`);
        }

        const result = await response.json();
        const transcript = result.results?.channels[0]?.alternatives[0]?.transcript || '';

        if (transcript.trim()) {
          finalTranscript += transcript + ' ';
          updateTranscript();
          sendTranscriptionToServer(transcript, true);
        }

        updateStatus('Conversazione attiva - Tieni premuto per registrare', 'active');

      } catch (error) {
        console.error('Deepgram error:', error);
        updateStatus('Errore trascrizione: ' + error.message, 'error');
        setTimeout(() => {
          if (conversationActive) {
            updateStatus('Conversazione attiva - Tieni premuto per registrare', 'active');
          }
        }, 3000);
      }
    }

    // ========== SEND TRANSCRIPTION TO SERVER ==========
    function sendTranscriptionToServer(text, isFinal) {
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.send(JSON.stringify({
          type: 'transcription',
          text: text,
          isFinal: isFinal,
          timestamp: new Date().toISOString()
        }));
      }
    }

    // ========== QUEUE CONTROL ==========
    leaveQueueBtn.addEventListener('click', () => {
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.send(JSON.stringify({
          type: 'leave_queue'
        }));
        
        relaySocket.close();
        returnToLanding();
      }
    });

    // ========== TRANSCRIPT ==========
    function updateTranscript() {
      transcriptDiv.textContent = finalTranscript;
      transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    }

    clearBtn.addEventListener('click', () => {
      finalTranscript = '';
      updateTranscript();
    });

    // ========== UTILITY FUNCTIONS ==========
    function updateStatus(message, type = 'idle') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    function handleError(error) {
      console.error('Error:', error);
      
      let errorMessage = 'Errore sconosciuto';
      
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        errorMessage = 'Permesso microfono negato. Abilita il microfono nelle impostazioni del browser.';
      } else if (error.name === 'NotFoundError') {
        errorMessage = 'Nessun microfono trovato';
      } else if (error.name === 'NotReadableError') {
        errorMessage = 'Microfono gi√† in uso da un\'altra applicazione';
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      updateStatus(errorMessage, 'error');
      isRecording = false;
      holdRecBtn.classList.remove('btn-recording');
    }

    function handleDisconnection() {
      stopRecording();
      updateStatus('Disconnesso dal server', 'error');
      
      setTimeout(() => {
        returnToLanding();
      }, 2000);
    }

    function returnToLanding() {
      mainApp.classList.remove('active');
      landingPage.style.display = 'flex';
      
      // Reset state
      userState = 'disconnected';
      conversationActive = false;
      isRecording = false;
      userId = null;
      queuePosition = null;
      finalTranscript = '';
      
      // Reset UI
      usernameInput.value = '';
      connectBtn.disabled = true;
      updateStatus('Disconnesso', 'idle');
    }

    // ========== CLEANUP ==========
    window.addEventListener('beforeunload', () => {
      if (isRecording) {
        stopRecording();
      }
      if (relaySocket && relaySocket.readyState === WebSocket.OPEN) {
        relaySocket.close();
      }
    });

    // ========== NOTIFICATIONS ==========
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  </script>
</body>
</html>
