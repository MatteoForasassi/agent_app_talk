<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Avatar AI | Voice Interface</title>
  <style>
    :root {
      --primary: #00d9ff;
      --primary-glow: rgba(0, 217, 255, 0.5);
      --secondary: #7000ff;
      --bg-dark: #0a0f18;
      --card-bg: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.1);
      --text-main: #e0e6ed;
      --text-dim: #94a3b8;
      --danger: #ff4757;
      --success: #2ed573;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
    }

    body {
      background: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(0, 217, 255, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(112, 0, 255, 0.05) 0%, transparent 40%);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
    }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* ========== LANDING PAGE ========== */
    #landingPage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 500px;
      padding: 40px;
      text-align: center;
      animation: fadeIn 0.8s ease-out;
    }

    .logo-container {
      font-size: 64px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 20px var(--primary-glow));
      animation: float 4s ease-in-out infinite;
    }

    h1 {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 12px;
      background: linear-gradient(to right, #fff, var(--primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .username-input {
      width: 100%;
      margin-top: 30px;
    }

    input[type="text"] {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 18px 24px;
      border-radius: 16px;
      color: white;
      font-size: 16px;
      outline: none;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }

    /* ========== MAIN CONTAINER ========== */
    .container {
      display: none;
      width: 100%;
      max-width: 800px;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
      animation: fadeIn 0.5s ease-out;
    }

    .container.active { display: flex; }

    /* ========== HUB SECTION (AVATAR STATE) ========== */
    .hub-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 30px;
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .avatar-visual {
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
    }

    .avatar-circle {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      z-index: 2;
      position: relative;
      box-shadow: 0 0 30px var(--primary-glow);
    }

    .pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--primary);
      animation: pulse-ring 2s infinite;
      z-index: 1;
    }

    .status-badge {
      padding: 6px 16px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }

    .status-badge.idle { background: rgba(255,255,255,0.1); color: #fff; }
    .status-badge.active { background: rgba(46, 213, 115, 0.2); color: var(--success); border: 1px solid var(--success); }

    /* ========== VISUALIZER ========== */
    .visualizer {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 30px;
      margin-top: 15px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .visualizer.recording { opacity: 1; }

    .bar {
      width: 4px;
      height: 10px;
      background: var(--primary);
      border-radius: 2px;
      animation: bar-dance 1s infinite ease-in-out;
    }

    @keyframes bar-dance {
      0%, 100% { height: 10px; }
      50% { height: 30px; }
    }

    /* ========== CHAT TRANSCRIPT ========== */
    .chat-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      height: 400px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #transcript {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bubble {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease-out;
    }

    .bubble.user {
      align-self: flex-end;
      background: var(--primary);
      color: #000;
      border-bottom-right-radius: 4px;
    }

    .bubble.avatar {
      align-self: flex-start;
      background: rgba(255,255,255,0.1);
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    .bubble.interim {
      opacity: 0.6;
      font-style: italic;
    }

    /* ========== BUTTONS ========== */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    button {
      padding: 16px;
      border-radius: 16px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 14px;
    }

    button:disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; }

    .btn-main { background: #fff; color: #000; }
    .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,255,255,0.1); }

    .btn-danger { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }

    .btn-rec { background: rgba(0, 217, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); }
    .btn-rec.recording { background: var(--danger); border-color: var(--danger); color: white; animation: pulse-red 1.5s infinite; }

    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
  </style>
</head>
<body>

  <!-- LANDING PAGE -->
  <div id="landingPage">
    <div class="logo-container">ðŸ¤–</div>
    <h1>Avatar Virtuale</h1>
    <p style="color: var(--text-dim)">Entra in un'esperienza di conversazione intelligente di prossima generazione.</p>
    
    <div class="username-input">
      <input type="text" id="usernameInput" placeholder="Inserisci il tuo nome...">
      <button id="connectBtn" class="btn-main" style="width: 100%; margin-top: 15px;" disabled>
        Inizia Esperienza
      </button>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="mainApp">
    
    <div class="hub-card">
      <div class="avatar-visual">
        <div class="pulse"></div>
        <div class="avatar-circle">ðŸ¤–</div>
      </div>
      <h2 id="userDisplay" style="margin-bottom: 5px;">-</h2>
      <div id="avatarState" class="status-badge idle">In attesa</div>
      
      <div class="visualizer" id="visualizer">
        <div class="bar" style="animation-delay: 0.1s"></div>
        <div class="bar" style="animation-delay: 0.2s"></div>
        <div class="bar" style="animation-delay: 0.3s"></div>
        <div class="bar" style="animation-delay: 0.4s"></div>
        <div class="bar" style="animation-delay: 0.5s"></div>
      </div>

      <div id="queueInfo" style="margin-top: 15px; font-size: 14px; color: var(--primary); display: none;">
        Posizione in coda: <strong id="queuePosition">0</strong>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <span style="font-weight: 700; font-size: 14px;">CONVERSAZIONE</span>
        <button id="clearBtn" style="padding: 5px 10px; font-size: 11px; background: transparent; color: var(--text-dim); border: 1px solid var(--border);">Svuota</button>
      </div>
      <div id="transcript"></div>
    </div>

    <div class="controls-grid">
      <button id="startConvBtn" class="btn-main" disabled>Inizia</button>
      <button id="endConvBtn" class="btn-danger" disabled>Esci</button>
      <button id="startRecBtn" class="btn-rec" style="grid-column: span 2;" disabled>
        <span>ðŸŽ¤</span> Avvia Registrazione
      </button>
      <button id="stopRecBtn" class="btn-danger" style="grid-column: span 2; display: none;">
        Ferma Registrazione
      </button>
    </div>

    <div id="status" style="text-align: center; font-size: 12px; color: var(--text-dim); margin-top: 10px;">
      Pronto per la connessione
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Config (Keep your existing API keys)
      const DEEPGRAM_API_KEY = '87ce09f5219486e115182b4252e98370723dda2b';
      const DEEPGRAM_URL = 'wss://api.deepgram.com/v1/listen?encoding=linear16&sample_rate=16000&channels=1&language=it&interim_results=true';
      const RELAY_SERVER_URL = 'wss://agent-app-talk.onrender.com';

      let relaySocket, deepgramSocket, audioStream, audioContext, processor;
      let userState = 'disconnected', conversationActive = false, isRecording = false, username = '';

      // DOM Elements
      const landingPage = document.getElementById('landingPage');
      const mainApp = document.getElementById('mainApp');
      const transcriptDiv = document.getElementById('transcript');
      const visualizer = document.getElementById('visualizer');

      // Utility: Add Message to UI
      function addMessage(text, side, isInterim = false) {
        if (isInterim) {
          let oldInterim = document.querySelector('.bubble.interim');
          if (oldInterim) oldInterim.remove();
        }

        const msg = document.createElement('div');
        msg.className = `bubble ${side} ${isInterim ? 'interim' : ''}`;
        msg.textContent = text;
        transcriptDiv.appendChild(msg);
        transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        return msg;
      }

      // Handle Connection
      document.getElementById('usernameInput').addEventListener('input', (e) => {
        document.getElementById('connectBtn').disabled = !e.target.value.trim();
      });

      document.getElementById('connectBtn').addEventListener('click', () => {
        username = document.getElementById('usernameInput').value;
        landingPage.style.display = 'none';
        mainApp.classList.add('active');
        connectToRelay();
      });

      function connectToRelay() {
        relaySocket = new WebSocket(RELAY_SERVER_URL);
        relaySocket.onopen = () => {
          relaySocket.send(JSON.stringify({ type: 'identify', client: 'web', username }));
        };
        relaySocket.onmessage = (e) => handleServerMessage(JSON.parse(e.data));
      }

      function handleServerMessage(msg) {
        const stateBadge = document.getElementById('avatarState');
        
        switch(msg.type) {
          case 'registered':
            document.getElementById('userDisplay').textContent = username;
            if(msg.state === 'active') {
              stateBadge.className = 'status-badge active';
              stateBadge.textContent = 'Il tuo turno';
              document.getElementById('startConvBtn').disabled = false;
            } else {
              document.getElementById('queueInfo').style.display = 'block';
              document.getElementById('queuePosition').textContent = msg.queuePosition;
            }
            break;
          case 'promoted_to_active':
            stateBadge.className = 'status-badge active';
            stateBadge.textContent = 'Il tuo turno';
            document.getElementById('startConvBtn').disabled = false;
            break;
          case 'conversation_started':
            conversationActive = true;
            document.getElementById('startConvBtn').disabled = true;
            document.getElementById('endConvBtn').disabled = false;
            document.getElementById('startRecBtn').disabled = false;
            break;
        }
      }

      // Voice Logic
      document.getElementById('startRecBtn').addEventListener('click', async () => {
        try {
          audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          deepgramSocket = new WebSocket(DEEPGRAM_URL, ['token', DEEPGRAM_API_KEY]);
          
          deepgramSocket.onopen = () => {
            isRecording = true;
            visualizer.classList.add('recording');
            document.getElementById('startRecBtn').style.display = 'none';
            document.getElementById('stopRecBtn').style.display = 'flex';
            setupAudioProcessing();
          };

          deepgramSocket.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            if (data.type === 'Results' && data.channel.alternatives[0].transcript) {
              const text = data.channel.alternatives[0].transcript;
              if (data.is_final) {
                addMessage(text, 'user');
                relaySocket.send(JSON.stringify({ type: 'transcription', text, isFinal: true }));
              } else {
                addMessage(text, 'user', true);
              }
            }
          };
        } catch(e) { console.error(e); }
      });

      function setupAudioProcessing() {
        audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(audioStream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);
        processor.onaudioprocess = (e) => {
          if (deepgramSocket.readyState === 1) {
            const inputData = e.inputBuffer.getChannelData(0);
            const int16Data = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              int16Data[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7FFF;
            }
            deepgramSocket.send(int16Data.buffer);
          }
        };
        source.connect(processor);
        processor.connect(audioContext.destination);
      }

      document.getElementById('stopRecBtn').addEventListener('click', () => {
        visualizer.classList.remove('recording');
        document.getElementById('startRecBtn').style.display = 'flex';
        document.getElementById('stopRecBtn').style.display = 'none';
        if (audioStream) audioStream.getTracks().forEach(t => t.stop());
        if (deepgramSocket) deepgramSocket.close();
      });

      document.getElementById('startConvBtn').addEventListener('click', () => {
        relaySocket.send(JSON.stringify({ type: 'start_conversation' }));
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        transcriptDiv.innerHTML = '';
      });
    });
  </script>
</body>
</html>
